<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ğŸ‰ åˆ‡è¥¿ç“œæ¸¸æˆ</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        
        .game-header {
            color: white;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .game-header h1 {
            font-size: 2.5em;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        #gameContainer {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            position: relative;
            max-width: 90vw;
        }
        
        canvas {
            display: block;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            background: #000;
            width: 800px;
            height: 600px;
            max-width: 100%;
            max-height: 70vh;
        }
        
        #status {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            text-align: center;
            z-index: 1000;
            background: rgba(0,0,0,0.9);
            padding: 30px;
            border-radius: 15px;
            min-width: 350px;
            max-width: 90vw;
        }
        
        .status-progress {
            width: 280px;
            height: 25px;
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            overflow: hidden;
            margin: 15px auto;
            position: relative;
        }
        
        .status-progress-inner {
            height: 100%;
            background: linear-gradient(90deg, #00ff88 0%, #00aaff 100%);
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 12px;
        }
        
        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 12px;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }
        
        .loading-text {
            color: #00ff88;
            font-size: 18px;
            margin: 10px 0;
        }
        
        .loading-subtitle {
            color: #ccc;
            font-size: 14px;
            margin: 5px 0;
        }
        
        .error-text {
            color: #ff6b6b;
            font-size: 16px;
            margin: 10px 0;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255,255,255,0.2);
            border-top: 4px solid #00ff88;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 15px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .instructions {
            background: rgba(255,255,255,0.1);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
            max-width: 600px;
        }
        
        .retry-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: background 0.3s ease;
        }
        
        .retry-button:hover {
            background: #5a6fd8;
        }
        
        .skip-button {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
    </style>
</head>
<body>
    <div class="game-header">
        <h1>ğŸ‰ åˆ‡è¥¿ç“œæ¸¸æˆ</h1>
        <p>å¹³è¡¡é¥¥é¥¿åº¦å’Œè¡€ç³–ï¼ŒæŒ‘æˆ˜ä½ çš„ç”Ÿå­˜æŠ€å·§ï¼</p>
    </div>
    
    <div id="gameContainer">
        <canvas id="canvas"></canvas>
        
        <div id="status">
            <div class="loading-spinner"></div>
            <div class="loading-text" id="main-text">ğŸ® å‡†å¤‡åŠ è½½æ¸¸æˆ...</div>
            <div class="loading-subtitle" id="sub-text">æ­£åœ¨æ£€æŸ¥æ¸¸æˆæ–‡ä»¶...</div>
            
            <div class="status-progress">
                <div class="status-progress-inner" id="progress"></div>
                <div class="progress-text" id="progress-text">0%</div>
            </div>
            
            <div id="detailed-status">
                <div style="font-size: 12px; color: #aaa; margin-top: 10px;">
                    æ¸¸æˆæ–‡ä»¶è¾ƒå¤§(~50MB)ï¼Œé¦–æ¬¡åŠ è½½éœ€è¦ä¸€äº›æ—¶é—´
                </div>
            </div>
        </div>
    </div>
    
    <div class="instructions">
        <strong>ğŸ•¹ï¸ æ“ä½œè¯´æ˜ï¼š</strong>
        é¼ æ ‡æ»‘åŠ¨åˆ‡å‰²è¥¿ç“œ | ç©ºæ ¼é”®æš‚åœ | å¹³è¡¡é¥¥é¥¿åº¦å’Œè¡€ç³–
    </div>

    <script src="./index.js"></script>
    <script>
        const canvas = document.getElementById('canvas');
        const statusDiv = document.getElementById('status');
        const mainText = document.getElementById('main-text');
        const subText = document.getElementById('sub-text');
        const progress = document.getElementById('progress');
        const progressText = document.getElementById('progress-text');
        const detailedStatus = document.getElementById('detailed-status');
        
        let gameStarted = false;
        let loadingStartTime = Date.now();
        let retryCount = 0;
        const maxRetries = 3;
        
        function updateStatus(main, sub = '', progressValue = null) {
            console.log('ğŸ“Š', main, sub);
            mainText.textContent = main;
            subText.textContent = sub;
            
            if (progressValue !== null && isFinite(progressValue)) {
                const percent = Math.min(Math.max(progressValue, 0), 100);
                progress.style.width = percent + '%';
                progressText.textContent = Math.round(percent) + '%';
            }
            
            // æ˜¾ç¤ºåŠ è½½æ—¶é—´
            const elapsed = Math.round((Date.now() - loadingStartTime) / 1000);
            if (elapsed > 5) {
                subText.textContent = sub + (sub ? ' | ' : '') + `å·²åŠ è½½ ${elapsed}ç§’`;
            }
        }
        
        function showError(message, canRetry = true) {
            console.error('âŒ é”™è¯¯:', message);
            
            let retryHtml = '';
            if (canRetry && retryCount < maxRetries) {
                retryHtml = `
                    <button class="retry-button" onclick="retryLoading()">
                        ğŸ”„ é‡è¯•åŠ è½½ (${retryCount + 1}/${maxRetries})
                    </button>
                `;
            }
            
            statusDiv.innerHTML = `
                <div class="error-text">ğŸ˜¢ æ¸¸æˆåŠ è½½å¤±è´¥</div>
                <div class="error-text">${message}</div>
                <div style="margin-top: 20px;">
                    <button class="retry-button" onclick="location.reload()">ğŸ”„ åˆ·æ–°é¡µé¢</button>
                    ${retryHtml}
                </div>
                <div style="margin-top: 15px;">
                    <button class="skip-button" onclick="showAlternatives()">ğŸ”§ å…¶ä»–é€‰é¡¹</button>
                </div>
                <div style="font-size: 12px; color: #aaa; margin-top: 15px;">
                    å»ºè®®ä½¿ç”¨Chromeæµè§ˆå™¨è·å¾—æœ€ä½³ä½“éªŒ
                </div>
            `;
        }
        
        function hideStatus() {
            if (!gameStarted) {
                gameStarted = true;
                console.log('âœ… æ¸¸æˆå¯åŠ¨æˆåŠŸï¼Œéšè—åŠ è½½ç•Œé¢');
                statusDiv.style.opacity = '0';
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 500);
            }
        }
        
        // é‡è¯•åŠ è½½å‡½æ•°
        window.retryLoading = function() {
            retryCount++;
            loadingStartTime = Date.now();
            statusDiv.innerHTML = `
                <div class="loading-spinner"></div>
                <div class="loading-text" id="main-text">ğŸ”„ é‡æ–°åŠ è½½ä¸­...</div>
                <div class="loading-subtitle" id="sub-text">ç¬¬ ${retryCount} æ¬¡å°è¯•</div>
                <div class="status-progress">
                    <div class="status-progress-inner" id="progress"></div>
                    <div class="progress-text" id="progress-text">0%</div>
                </div>
            `;
            
            // é‡æ–°è·å–å…ƒç´ å¼•ç”¨
            const newMainText = document.getElementById('main-text');
            const newSubText = document.getElementById('sub-text');
            const newProgress = document.getElementById('progress');
            const newProgressText = document.getElementById('progress-text');
            
            setTimeout(() => {
                startGame();
            }, 1000);
        };
        
        // æ˜¾ç¤ºæ›¿ä»£é€‰é¡¹
        window.showAlternatives = function() {
            statusDiv.innerHTML = `
                <div class="loading-text">ğŸ”§ å…¶ä»–é€‰é¡¹</div>
                <div style="margin: 20px 0; text-align: left; color: #ddd;">
                    <p><strong>å¦‚æœæ¸¸æˆä¸€ç›´æ— æ³•åŠ è½½ï¼Œè¯·å°è¯•ï¼š</strong></p>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>æ¸…é™¤æµè§ˆå™¨ç¼“å­˜å¹¶åˆ·æ–°</li>
                        <li>ä½¿ç”¨Chromeæˆ–Firefoxæµè§ˆå™¨</li>
                        <li>æ£€æŸ¥ç½‘ç»œè¿æ¥æ˜¯å¦ç¨³å®š</li>
                        <li>ç¨åå†è¯•ï¼ˆæœåŠ¡å™¨å¯èƒ½ç¹å¿™ï¼‰</li>
                    </ul>
                </div>
                <div style="margin-top: 20px;">
                    <button class="retry-button" onclick="location.reload()">ğŸ”„ åˆ·æ–°é¡µé¢</button>
                    <button class="retry-button" onclick="window.open('/', '_blank')">ğŸ  è¿”å›ä¸»é¡µ</button>
                </div>
            `;
        };

        async function startGame() {
            try {
                updateStatus('ğŸ” æ£€æŸ¥æµè§ˆå™¨å…¼å®¹æ€§...', 'æ­£åœ¨éªŒè¯WebGLå’ŒWebAssemblyæ”¯æŒ', 5);
                
                // æ£€æŸ¥WebAssemblyæ”¯æŒ
                if (typeof WebAssembly === 'undefined') {
                    throw new Error('æµè§ˆå™¨ä¸æ”¯æŒWebAssemblyï¼Œè¯·æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬');
                }
                
                // æ£€æŸ¥WebGLæ”¯æŒ
                const gl = canvas.getContext('webgl2') || canvas.getContext('webgl');
                if (!gl) {
                    console.warn('âš ï¸ WebGLä¸å¯ç”¨ï¼Œå°è¯•å…¼å®¹æ¨¡å¼');
                }
                
                updateStatus('ğŸš€ åˆå§‹åŒ–æ¸¸æˆå¼•æ“...', 'æ­£åœ¨åŠ è½½Godotå¼•æ“', 10);
                
                // æ£€æŸ¥Engineæ˜¯å¦å¯ç”¨
                if (typeof Engine === 'undefined') {
                    throw new Error('æ¸¸æˆå¼•æ“è„šæœ¬æœªæ­£ç¡®åŠ è½½');
                }
                
                // æ£€æŸ¥ç¼ºå¤±åŠŸèƒ½
                const missing = Engine.getMissingFeatures();
                if (missing.length > 0) {
                    console.warn('âš ï¸ éƒ¨åˆ†åŠŸèƒ½ç¼ºå¤±ï¼Œä½¿ç”¨å…¼å®¹æ¨¡å¼:', missing);
                    updateStatus('âš™ï¸ ä½¿ç”¨å…¼å®¹æ¨¡å¼...', 'æ£€æµ‹åˆ°æµè§ˆå™¨é™åˆ¶ï¼Œæ­£åœ¨é€‚é…', 15);
                } else {
                    updateStatus('âœ… å®Œæ•´åŠŸèƒ½æ¨¡å¼...', 'æµè§ˆå™¨å®Œå…¨å…¼å®¹', 15);
                }
                
                updateStatus('ğŸ“¦ å‡†å¤‡ä¸‹è½½æ¸¸æˆæ–‡ä»¶...', 'æ–‡ä»¶å¤§å°çº¦50MBï¼Œè¯·è€å¿ƒç­‰å¾…', 20);
                
                // åˆ›å»ºå¼•æ“å®ä¾‹
                const engine = new Engine();
                
                // è®¾ç½®è¶…æ—¶
                const loadingTimeout = setTimeout(() => {
                    throw new Error('åŠ è½½è¶…æ—¶ï¼Œæ–‡ä»¶å¯èƒ½è¿‡å¤§æˆ–ç½‘ç»œä¸ç¨³å®š');
                }, 120000); // 2åˆ†é’Ÿè¶…æ—¶
                
                try {
                    updateStatus('â¬‡ï¸ ä¸‹è½½WebAssemblyæ–‡ä»¶...', 'æ­£åœ¨ä¸‹è½½index.wasm (çº¦50MB)', 25);
                    
                    // åˆ†æ­¥åŠ è½½ï¼Œå…ˆåˆå§‹åŒ–å¼•æ“
                    await engine.init('./index.wasm');
                    console.log('âœ… WebAssemblyæ–‡ä»¶åŠ è½½æˆåŠŸ');
                    
                    clearTimeout(loadingTimeout);
                    
                    updateStatus('ğŸ® å¯åŠ¨æ¸¸æˆ...', 'æ­£åœ¨åŠ è½½æ¸¸æˆèµ„æºåŒ…', 70);
                    
                    // ç„¶åå¯åŠ¨æ¸¸æˆ
                    await engine.startGame('./index.pck', {
                        'onProgress': function(current, total) {
                            if (total > 0 && isFinite(current) && isFinite(total)) {
                                const percent = 70 + Math.round((current / total) * 25); // 70-95%
                                const currentMB = Math.round(current / 1024 / 1024);
                                const totalMB = Math.round(total / 1024 / 1024);
                                updateStatus('ğŸ“¦ åŠ è½½æ¸¸æˆèµ„æº...', `${currentMB}MB / ${totalMB}MB`, percent);
                            } else if (current > 0) {
                                const currentMB = Math.round(current / 1024 / 1024);
                                const estimatedPercent = 70 + Math.min((current / 10000000) * 25, 25);
                                updateStatus('ğŸ“¦ åŠ è½½æ¸¸æˆèµ„æº...', `å·²åŠ è½½ ${currentMB}MB`, estimatedPercent);
                            }
                        }
                    });
                    
                } catch (loadError) {
                    clearTimeout(loadingTimeout);
                    throw loadError;
                }
                
                console.log('ğŸ‰ æ¸¸æˆå¯åŠ¨å®Œæˆ');
                updateStatus('ğŸ‰ æ¸¸æˆå‡†å¤‡å°±ç»ªï¼', 'å³å°†è¿›å…¥æ¸¸æˆ...', 100);
                
                // ç­‰å¾…æ¸²æŸ“å¼€å§‹
                setTimeout(() => {
                    hideStatus();
                    canvas.focus();
                }, 3000);
                
            } catch (error) {
                console.error('ğŸ’¥ æ¸¸æˆå¯åŠ¨å¤±è´¥:', error);
                
                let errorMessage = error.message;
                let canRetry = true;
                
                if (error.message.includes('è¶…æ—¶')) {
                    errorMessage = 'ç½‘ç»œåŠ è½½è¶…æ—¶ï¼Œæ–‡ä»¶è¾ƒå¤§è¯·ç¨åé‡è¯•';
                } else if (error.message.includes('SharedArrayBuffer')) {
                    errorMessage = 'æµè§ˆå™¨å®‰å…¨é™åˆ¶ï¼Œå»ºè®®ä½¿ç”¨Chromeæµè§ˆå™¨';
                    canRetry = false;
                } else if (error.message.includes('WebAssembly')) {
                    errorMessage = 'æµè§ˆå™¨ä¸æ”¯æŒWebAssemblyï¼Œè¯·æ›´æ–°æµè§ˆå™¨';
                    canRetry = false;
                } else if (error.message.includes('fetch') || error.message.includes('network')) {
                    errorMessage = 'ç½‘ç»œè¿æ¥é—®é¢˜æˆ–æ–‡ä»¶æŸå';
                }
                
                showError(errorMessage, canRetry);
            }
        }
        
        // ç›‘å¬æ¸¸æˆæ¸²æŸ“
        function monitorGameRendering() {
            let checkCount = 0;
            const maxChecks = 60; // 1åˆ†é’Ÿ
            
            const renderCheck = setInterval(() => {
                checkCount++;
                
                if (gameStarted || checkCount > maxChecks) {
                    clearInterval(renderCheck);
                    return;
                }
                
                try {
                    const ctx = canvas.getContext('2d');
                    if (ctx) {
                        const imageData = ctx.getImageData(50, 50, 100, 100);
                        let hasContent = false;
                        
                        for (let i = 0; i < imageData.data.length; i += 4) {
                            const r = imageData.data[i];
                            const g = imageData.data[i + 1];
                            const b = imageData.data[i + 2];
                            if (r > 30 || g > 30 || b > 30) {
                                hasContent = true;
                                break;
                            }
                        }
                        
                        if (hasContent) {
                            console.log('ğŸ¨ æ£€æµ‹åˆ°æ¸¸æˆæ¸²æŸ“å†…å®¹');
                            hideStatus();
                            clearInterval(renderCheck);
                        }
                    }
                } catch (e) {
                    // å¿½ç•¥é”™è¯¯ï¼Œç»§ç»­æ£€æŸ¥
                }
            }, 1000);
        }
        
        // å¼€å§‹åŠ è½½
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                startGame();
                monitorGameRendering();
            });
        } else {
            startGame();
            monitorGameRendering();
        }
        
        // é˜²æ­¢ç©ºæ ¼é”®æ»šåŠ¨é¡µé¢
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space') {
                e.preventDefault();
            }
        });
        
        console.log('ğŸ® å¤§æ–‡ä»¶åŠ è½½å™¨å·²å‡†å¤‡å°±ç»ª');
    </script>
</body>
</html>