<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>游戏诊断</title>
    <style>
        body { background: #222; color: white; font-family: monospace; padding: 20px; }
        .log { background: #333; padding: 10px; margin: 5px 0; border-radius: 5px; }
        .error { background: #500; }
        .success { background: #050; }
        .warning { background: #550; }
        canvas { border: 1px solid #666; margin: 20px 0; }
    </style>
</head>
<body>
    <h1>🔧 切西瓜游戏诊断工具</h1>
    <div id="logs"></div>
    <canvas id="canvas" width="800" height="600"></canvas>
    
    <script>
        const logs = document.getElementById('logs');
        const canvas = document.getElementById('canvas');
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.textContent = new Date().toLocaleTimeString() + ' - ' + message;
            logs.appendChild(div);
            console.log(message);
            logs.scrollTop = logs.scrollHeight;
        }
        
        async function diagnose() {
            log('🔍 开始诊断...', 'info');
            
            // 1. 检查必要文件
            const files = ['./index.js', './index.wasm', './index.pck'];
            for (const file of files) {
                try {
                    log(`检查文件: ${file}`, 'info');
                    const response = await fetch(file, { method: 'HEAD' });
                    if (response.ok) {
                        const size = response.headers.get('content-length');
                        log(`✅ ${file} 存在 (大小: ${size ? (size/1024/1024).toFixed(2) + 'MB' : '未知'})`, 'success');
                    } else {
                        log(`❌ ${file} 不存在 (状态: ${response.status})`, 'error');
                        return;
                    }
                } catch (error) {
                    log(`❌ 无法访问 ${file}: ${error.message}`, 'error');
                    return;
                }
            }
            
            // 2. 检查WebGL支持
            log('检查WebGL支持...', 'info');
            const gl = canvas.getContext('webgl2') || canvas.getContext('webgl');
            if (gl) {
                log('✅ WebGL支持正常', 'success');
                log(`WebGL版本: ${gl.getParameter(gl.VERSION)}`, 'info');
                log(`渲染器: ${gl.getParameter(gl.RENDERER)}`, 'info');
            } else {
                log('❌ WebGL不支持', 'error');
                return;
            }
            
            // 3. 检查Godot引擎加载
            log('加载Godot引擎...', 'info');
            try {
                // 动态加载index.js
                const script = document.createElement('script');
                script.src = './index.js';
                script.onload = () => {
                    log('✅ Godot引擎脚本加载成功', 'success');
                    testEngine();
                };
                script.onerror = (error) => {
                    log('❌ Godot引擎脚本加载失败', 'error');
                    log(`错误详情: ${error.message || '未知错误'}`, 'error');
                };
                document.head.appendChild(script);
            } catch (error) {
                log(`❌ 引擎加载异常: ${error.message}`, 'error');
            }
        }
        
        function testEngine() {
            log('测试Godot引擎...', 'info');
            
            try {
                if (typeof Engine === 'undefined') {
                    log('❌ Engine类未定义', 'error');
                    return;
                }
                
                log('✅ Engine类可用', 'success');
                
                // 检查必要的方法
                const methods = ['getMissingFeatures', 'load', 'unload'];
                methods.forEach(method => {
                    if (typeof Engine[method] === 'function') {
                        log(`✅ Engine.${method} 可用`, 'success');
                    } else {
                        log(`❌ Engine.${method} 不可用`, 'error');
                    }
                });
                
                // 检查缺失的功能
                const missing = Engine.getMissingFeatures();
                if (missing.length === 0) {
                    log('✅ 所有必需功能都可用', 'success');
                } else {
                    log(`⚠️ 缺失功能: ${missing.join(', ')}`, 'warning');
                }
                
                // 尝试创建引擎实例
                log('创建引擎实例...', 'info');
                const engine = new Engine({
                    canvas: canvas,
                    executable: 'index',
                    threads: false,
                    canvasResizePolicy: 0
                });
                
                log('✅ 引擎实例创建成功', 'success');
                
                // 尝试启动游戏
                log('尝试启动游戏...', 'info');
                engine.startGame({
                    onProgress: function(current, total) {
                        log(`加载进度: ${current}/${total} (${((current/total)*100).toFixed(1)}%)`, 'info');
                    }
                }).then(() => {
                    log('🎉 游戏启动成功！', 'success');
                }).catch(error => {
                    log(`❌ 游戏启动失败: ${error.message}`, 'error');
                    log(`错误堆栈: ${error.stack}`, 'error');
                });
                
            } catch (error) {
                log(`❌ 引擎测试异常: ${error.message}`, 'error');
                log(`错误堆栈: ${error.stack}`, 'error');
            }
        }
        
        // 开始诊断
        diagnose();
    </script>
</body>
</html>